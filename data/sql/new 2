select distinct 
	dr.id AS id,
	p.id AS producto_id,
	p.codigo AS codigo,
	replace(dc.nro_lote, 'T ', '') AS nro_lote,
	coalesce(dc.fecha_vto, 'no tiene') AS fecha_vto,
	r.id AS resumen_id,
	r.fecha AS fecha_venta,
	c.id AS cliente_id,
	c.apellido AS apellido,
	c.nombre AS nombre,
	com.fecha AS fecha_compra,
	prov.id AS proveedor_id,
	com.id AS compra_id,
	case when isnull(dp.cantidad) then dr.cantidad else dr.cantidad - dp.cantidad end AS cant_vendida,
	dc.cantidad AS cant_comprada
from 
	producto p 
		join detalle_resumen dr on p.id = dr.producto_id
		join resumen r on dr.resumen_id = r.id
		join cliente c on r.cliente_id = c.id
		join detalle_compra dc on dr.producto_id = dc.producto_id and dr.nro_lote = dc.nro_lote
		join compra com on dc.compra_id = com.id and r.zona_id = com.zona_id
		join proveedor prov on com.proveedor_id = prov.id
		left join dev_producto dp on dr.resumen_id = dp.resumen_id and dr.producto_id = dp.producto_id and dr.nro_lote <> 0 and dp.nro_lote <> 0
where 
	dc.trazable = 1
	and not(dr.nro_lote in (select lotes_romi.nro_lote from lotes_romi))
	and not(dc.nro_lote in (select lotes_romi.nro_lote from lotes_romi))
	and com.proveedor_id <> 13)
having 
	(cant_vendida > 0) 